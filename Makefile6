.PHONY: ds-setup lib389 rest389 pyldap

DEVDIR ?= $(shell pwd)
BUILDDIR ?= ~/build
LIB389_VERS ?= $(shell cat ./lib389/VERSION | head -n 1)
REST389_VERS ?= $(shell cat ./rest389/VERSION | head -n 1)
PYTHON ?= /usr/bin/python

all:
	echo "make ds|nunc-stans|lib389|ds-setup"

builddeps:
	sudo yum install -y rpm-build gcc autoconf make automake libtool libasan rpmdevtools gcc-g++ pam-devel openldap-devel db4-devel db4 svrcore-devel libicu-devel net-snmp-devel pcre-devel \
		python34 python34-devel python34-setuptools python34-six python-pyasn1 \
		`grep "^BuildRequires" ds/rpm/389-ds-base.spec.in svrcore/svrcore.spec rest389/python-rest389.spec lib389/python-lib389.spec | awk '{ print $$2 }' | grep -v "^/"`
	sudo easy_install pip
	sudo pip install pyasn1 pyasn1-modules

clean: ds-clean nunc-stans-clean svrcore-clean

pyldap:
	cd $(DEVDIR)/pyldap/ && $(PYTHON) setup.py build
	cd $(DEVDIR)/pyldap/ && sudo $(PYTHON) setup.py install --force --root=/

lib389: 
	make -C $(DEVDIR)/lib389/ build
	sudo make -C $(DEVDIR)/lib389/ install

lib389-rpmbuild-prep:
	make -C $(DEVDIR)/lib389/ rpmbuild-prep

lib389-srpms: lib389-rpmbuild-prep
	mkdir -p $(DEVDIR)/rpmbuild/SRPMS/
	make -C $(DEVDIR)/lib389/ srpm
	cp $(DEVDIR)/lib389/dist/python-lib389*.src.rpm $(DEVDIR)/rpmbuild/SRPMS/

lib389-rpms: lib389-rpmbuild-prep
	make -C $(DEVDIR)/lib389/ rpm
	cp ~/rpmbuild/RPMS/noarch/python-lib389*.rpm $(DEVDIR)/rpmbuild/RPMS/noarch/

nunc-stans-configure:
	cd $(DEVDIR)/nunc-stans/ && autoreconf --force --install
	mkdir -p $(BUILDDIR)/nunc-stans
	cd $(BUILDDIR)/nunc-stans && $(DEVDIR)/nunc-stans/configure --prefix=/opt/dirsrv

nunc-stans: nunc-stans-configure
	make -C $(BUILDDIR)/nunc-stans/
	sudo make -C $(BUILDDIR)/nunc-stans/ install
	sudo cp $(DEVDIR)/nunc-stans/liblfds/bin/* /opt/dirsrv/lib/

nunc-stans-clean:
	make -C $(BUILDDIR)/nunc-stans/ clean

svrcore-configure:
	cd $(DEVDIR)/svrcore/ && autoreconf --force --install
	mkdir -p $(BUILDDIR)/svrcore
	cd $(BUILDDIR)/svrcore && $(DEVDIR)/svrcore/configure --prefix=/opt/dirsrv --enable-debug --with-systemd #--enable-asan

svrcore: svrcore-configure
	make -C $(BUILDDIR)/svrcore
	sudo make -C $(BUILDDIR)/svrcore install

svrcore-clean:
	make -C $(BUILDDIR)/svrcore clean

svrcore-rpms: svrcore-configure
	make -C $(BUILDDIR)/svrcore rpms
	cp $(BUILDDIR)/svrcore/rpmbuild/RPMS/x86_64/svrcore*.rpm $(DEVDIR)/rpmbuild/RPMS/x86_64/

svrcore-srpms: svrcore-configure
	mkdir -p $(DEVDIR)/rpmbuild/SRPMS/
	make -C $(BUILDDIR)/svrcore srpm
	cp $(BUILDDIR)/svrcore/rpmbuild/SRPMS/svrcore*.src.rpm $(DEVDIR)/rpmbuild/SRPMS/

# Can I improve this to not need svrcore?
ds-configure: 
	cd $(DEVDIR)/ds && autoreconf
	mkdir -p $(BUILDDIR)/ds/
	cd $(BUILDDIR)/ds/ && CFLAGS=-O0 $(DEVDIR)/ds/configure --enable-debug --prefix=/opt/dirsrv --enable-gcc-security --with-openldap #--enable-asan --enable-auto-dn-suffix --enable-autobind --with-systemd --with-journald

ds: builddeps lib389 ds-configure
	make -C $(BUILDDIR)/ds 1> /tmp/buildlog
	sudo make -C $(BUILDDIR)/ds install 1>> /tmp/buildlog
	# sudo cp $(DEVDIR)/start-dirsrv-asan /opt/dirsrv/sbin/start-dirsrv

ds-clean:
	make -C $(BUILDDIR)/ds clean

ds-rpms: ds-configure
	make -C $(BUILDDIR)/ds rpmsources
	make -C $(BUILDDIR)/ds rpms
	cp $(BUILDDIR)/ds/rpmbuild/RPMS/x86_64/389-ds-base*.rpm $(DEVDIR)/rpmbuild/RPMS/x86_64/

ds-srpms: ds-configure
	mkdir -p $(DEVDIR)/rpmbuild/SRPMS/
	make -C $(BUILDDIR)/ds rpmsources
	make -C $(BUILDDIR)/ds srpm
	cp $(BUILDDIR)/ds/rpmbuild/SRPMS/389-ds-base*.src.rpm $(DEVDIR)/rpmbuild/SRPMS/

ds-setup:
	sudo /opt/dirsrv/sbin/setup-ds.pl --silent --debug --file=$(DEVDIR)/setup.inf General.FullMachineName=$$(hostname)

rest389: lib389
	cd $(DEVDIR)/rest389/ && $(PYTHON) setup.py build
	cd $(DEVDIR)/rest389/ && sudo $(PYTHON) setup.py install --force --root=/

rest389-rpmbuild-prep:
	mkdir -p $(DEVDIR)/rest389/dist
	mkdir -p ~/rpmbuild/SOURCES
	mkdir -p ~/rpmbuild/SPECS
	cd $(DEVDIR)/rest389/ && git archive --prefix=python-rest389-$(REST389_VERS)-1/ HEAD | bzip2 > $(DEVDIR)/rest389/dist/python-rest389-$(REST389_VERS)-1.tar.bz2
	cp $(DEVDIR)/rest389/dist/*.tar.bz2 ~/rpmbuild/SOURCES/

rest389-srpms: rest389-rpmbuild-prep
	mkdir -p $(DEVDIR)/rpmbuild/SRPMS/
	rpmbuild -bs $(DEVDIR)/rest389/python-rest389.spec
	cp ~/rpmbuild/SRPMS/python-rest389*.src.rpm $(DEVDIR)/rpmbuild/SRPMS/

rest389-rpms: rest389-rpmbuild-prep
	rpmbuild -bb $(DEVDIR)/rest389/python-rest389.spec
	cp ~/rpmbuild/RPMS/noarch/python-rest389*.rpm $(DEVDIR)/rpmbuild/RPMS/noarch/

clone:
	git clone ssh://git.fedorahosted.org/git/389/ds.git
	git clone ssh://git.fedorahosted.org/git/nunc-stans.git
	git clone ssh://git.fedorahosted.org/git/389/lib389.git
	git clone ssh://git.fedorahosted.org/git/rest389.git
	git clone ssh://git@pagure.io/svrcore.git

clone-anon:
	git clone https://git.fedorahosted.org/git/389/ds.git
	git clone https://git.fedorahosted.org/git/nunc-stans.git
	git clone https://git.fedorahosted.org/git/389/lib389.git
	git clone https://git.fedorahosted.org/git/rest389.git
	git clone https://pagure.io/svrcore.git

pull:
	cd ds; git pull
	cd lib389; git pull
	cd rest389; git pull
	cd nunc-stans; git pull
	cd svrcore; git pull

github-commit:
	echo you should be on the master branches here!
	cd ds; git push github
	cd lib389; git push github
	cd rest389; git push github
	cd svrcore; git push github
	cd nunc-stans; git push github

rpms: ds-rpms lib389-rpms rest389-rpms svrcore-rpms

srpms: ds-srpms lib389-srpms rest389-srpms svrcore-srpms

# Is there a nicer way to do this?
copr-wait:
	# Upload all the sprms to copr as builds
	copr-cli build lib389 `ls -1t $(DEVDIR)/rpmbuild/SRPMS/python-lib389*.src.rpm | head -n 1`
	copr-cli build rest389 `ls -1t $(DEVDIR)/rpmbuild/SRPMS/python-rest389*.src.rpm | head -n 1`
	copr-cli build ds `ls -1t $(DEVDIR)/rpmbuild/SRPMS/389-ds-base*.src.rpm | head -n 1`
	copr-cli build svrcore `ls -1t $(DEVDIR)/rpmbuild/SRPMS/svrcore*.src.rpm | head -n 1`

copr:
	# Upload all the sprms to copr as builds
	copr-cli build lib389 --nowait `ls -1t $(DEVDIR)/rpmbuild/SRPMS/python-lib389*.src.rpm | head -n 1`
	copr-cli build rest389 --nowait `ls -1t $(DEVDIR)/rpmbuild/SRPMS/python-rest389*.src.rpm | head -n 1`
	copr-cli build ds --nowait `ls -1t $(DEVDIR)/rpmbuild/SRPMS/389-ds-base*.src.rpm | head -n 1`
	copr-cli build svrcore --nowait `ls -1t $(DEVDIR)/rpmbuild/SRPMS/svrcore*.src.rpm | head -n 1`

